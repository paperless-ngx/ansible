---
- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Verify all paperless services are running
  become: true
  ansible.builtin.service_facts:
  register: _services_state

- name: Assert all enabled services are running
  when:
    - item.enabled is not none
    - item.enabled | bool
  ansible.builtin.assert:
    that: _services_state.ansible_facts.services[item.name].state == 'running'
    fail_msg: "Service {{ item.name }} is not running"
  loop: "{{ paperless_ngx_services_list }}"

- name: Write installation version file
  become: true
  ansible.builtin.copy:
    dest: "{{ paperless_ngx_dir_installation }}/.installed_version"
    content: "{{ paperless_ngx_version }}"
    owner: "{{ paperless_ngx_system_user }}"
    group: "{{ paperless_ngx_system_group }}"
    mode: "0640"
...
